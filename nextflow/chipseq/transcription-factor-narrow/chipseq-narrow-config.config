// ChIP-seq Transcription Factor (Narrow Peak) Configuration
// Optimized for narrow peak calling with MACS2 for transcription factor binding sites
// Configured for LARGE node (64 CPUs, 360GB RAM)

process {
    // Default resource allocation
    cpus = 4
    memory = '16.GB'
    time = '12.h'

    // Quality control processes
    withName:FASTQC {
        cpus = 8
        memory = '16.GB'
        time = '6.h'
    }

    withName:MULTIQC {
        cpus = 4
        memory = '8.GB'
        time = '4.h'
    }

    // Trimming processes
    withName:'.*:TRIMGALORE.*' {
        cpus = 6
        memory = '24.GB'
        time = '12.h'
    }

    // Alignment processes - BWA-MEM for ChIP-seq
    withName:'.*:BWA_MEM.*' {
        cpus = 16
        memory = '48.GB'
        time = '24.h'
    }

    withName:'.*:BOWTIE2_ALIGN.*' {
        cpus = 12
        memory = '32.GB'
        time = '16.h'
    }

    withName:'.*:CHROMAP_CHROMAP.*' {
        cpus = 12
        memory = '32.GB'
        time = '16.h'
    }

    withName:'.*:STAR_ALIGN.*' {
        cpus = 16
        memory = '48.GB'
        time = '16.h'
    }

    // Post-alignment filtering and processing
    withName:'.*:BAM_FILTER.*' {
        cpus = 8
        memory = '24.GB'
        time = '12.h'
    }

    withName:'.*:PICARD_MERGESAMFILES.*' {
        cpus = 4
        memory = '32.GB'
        time = '12.h'
    }

    withName:'.*:PICARD_MARKDUPLICATES.*' {
        cpus = 4
        memory = '32.GB'
        time = '12.h'
    }

    // Peak calling - MACS2 for narrow peaks (transcription factors)
    withName:'.*:MACS2_CALLPEAK.*' {
        cpus = 4
        memory = '24.GB'
        time = '12.h'
    }

    withName:'.*:MACS3_CALLPEAK.*' {
        cpus = 4
        memory = '24.GB'
        time = '12.h'
    }

    // Consensus peak analysis
    withName:'.*:HOMER_ANNOTATEPEAKS.*' {
        cpus = 6
        memory = '24.GB'
        time = '8.h'
    }

    withName:'.*:SUBREAD_FEATURECOUNTS.*' {
        cpus = 8
        memory = '24.GB'
        time = '8.h'
    }

    // Genome preparation processes
    withName:'.*:BWA_INDEX.*' {
        cpus = 12
        memory = '48.GB'
        time = '12.h'
    }

    withName:'.*:BOWTIE2_BUILD.*' {
        cpus = 12
        memory = '48.GB'
        time = '12.h'
    }

    // Process labels
    withLabel:process_single { cpus = 1; memory = '6.GB'; time = '6.h' }
    withLabel:process_low { cpus = 4; memory = '16.GB'; time = '12.h' }
    withLabel:process_medium { cpus = 8; memory = '32.GB'; time = '16.h' }
    withLabel:process_high { cpus = 16; memory = '64.GB'; time = '24.h' }
    withLabel:process_long { cpus = 4; memory = '24.GB'; time = '48.h' }
    withLabel:process_high_memory { cpus = 12; memory = '96.GB'; time = '24.h' }

    // Error handling
    errorStrategy = 'retry'
    maxRetries = 2
}

// Container configuration for Camber platform
singularity {
    enabled = true
    autoMounts = true
}

docker {
    enabled = false  // CRITICAL: Docker not available on Camber platform
}

// ChIP-seq specific parameters - hardcoded for narrow peak calling
params {
    // Narrow peak mode for transcription factors
    narrow_peak = true

    // Skip broad peak calling (not relevant for transcription factors)
    skip_peak_annotation = false
    skip_peak_qc = false

    // MACS2 settings optimized for narrow peaks
    macs_gsize = 'hs'  // Will be overridden by genome parameter

    // Skip unnecessary tools for this use case
    skip_ataqv = true
    skip_preseq = true

    // Fragment size estimation (important for narrow peaks)
    fragment_size = 200

    // Keep merged library BAMs for consensus peak calling
    save_align_intermeds = false
    save_macs_pileup = false
}