// Platform-specific configuration for nf-core/imcyto on Camber
// This pipeline requires Nextflow DSL1 (version â‰¤22.10.6)

process {
  // Default resource allocation
  cpus = { 4 * task.attempt }
  memory = { 16.GB * task.attempt }
  time = { 4.h * task.attempt }

  // CellProfiler preprocessing processes
  withName:'PREPROCESS_FULL_STACK' {
    cpus = { 8 * task.attempt }
    memory = { 32.GB * task.attempt }
    time = { 6.h * task.attempt }
  }

  withName:'PREPROCESS_ILASTIK_STACK' {
    cpus = { 8 * task.attempt }
    memory = { 32.GB * task.attempt }
    time = { 6.h * task.attempt }
  }

  // Ilastik pixel classification (memory intensive)
  withName:'ILASTIK_PREDICT' {
    cpus = { 12 * task.attempt }
    memory = { 64.GB * task.attempt }
    time = { 8.h * task.attempt }
  }

  // Cell segmentation (CellProfiler)
  withName:'SEGMENTATION' {
    cpus = { 12 * task.attempt }
    memory = { 48.GB * task.attempt }
    time = { 8.h * task.attempt }
  }

  // Image conversion and splitting
  withName:'IMCTOOLS_CONVERT' {
    cpus = { 4 * task.attempt }
    memory = { 24.GB * task.attempt }
    time = { 4.h * task.attempt }
  }

  // Resource limits for retry attempts
  errorStrategy = { task.exitStatus in [143,137,104,134,139] ? 'retry' : 'finish' }
  maxRetries = 2
  maxErrors = '-1'
}

// Container configuration
singularity {
  enabled = true
  autoMounts = true
  cacheDir = '/tmp/singularity'
}

docker {
  enabled = false  // Disable Docker for Camber platform
}

// Execution settings
executor {
  queueSize = 50
  pollInterval = '30 sec'
}

// Resource cleanup
cleanup = true
