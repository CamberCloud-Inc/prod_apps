# Python script (License CC BY 4.0)
# By Simon Gravelle, Jacob R. Gissinger, and Axel Kohlmeyer  
# The DOI will be added upon publication
# Find more on GitHub: https://github.com/lammpstutorials

# LEFT_FORCE_DURATION will be passed via -var flag
# If not passed, LAMMPS will error and show the usage

units real
atom_style molecular
boundary f f f

pair_style lj/cut 14.0
bond_style harmonic
angle_style harmonic
dihedral_style opls
improper_style harmonic
special_bonds lj 0.0 0.0 0.5

read_data unbreakable.data
include unbreakable.inc

group carbon_atoms type 1
variable xmax equal bound(carbon_atoms,xmax)-0.5
variable xmin equal bound(carbon_atoms,xmin)+0.5
region rtop block ${xmax} INF INF INF INF INF
region rbot block INF ${xmin} INF INF INF INF
region rmid block ${xmin} ${xmax} INF INF INF INF

group cnt_top region rtop
group cnt_bot region rbot
group cnt_mid region rmid
set group cnt_top mol 1
set group cnt_bot mol 2
set group cnt_mid mol 3

variable xmax_del equal ${xmax}-2
variable xmin_del equal ${xmin}+2
region rdel block ${xmin_del} ${xmax_del} INF INF INF INF
group rdel region rdel
delete_atoms random fraction 0.02 no rdel NULL 2793 bond yes

reset_atoms id sort yes
velocity cnt_mid create 300 48455 mom yes rot yes

fix mynve1 cnt_top nve
fix mynve2 cnt_bot nve
fix mynvt cnt_mid nvt temp 300 300 100

fix mysf1 cnt_top setforce 0 0 0
fix mysf2 cnt_bot setforce 0 0 0
velocity cnt_top set 0 0 0
velocity cnt_bot set 0 NULL NULL

variable Lcnt equal xcm(cnt_top,x)-xcm(cnt_bot,x)
variable Fcnt equal f_mysf1[1]-f_mysf2[1]

# Add trajectory dump
dump trajectory all custom 100 ../output/trajectory.lammpstrj id mol type x y z

# Remove this line completely:
# dump bonds all local 100 bonds.dat index c_bond[*][1] c_bond[*][2]

# --- Add this at the top to ensure all thermo goes to a single file ---
log ../output/thermo_full.log

# --- Temperature CSV output for complete simulation ---
variable temp_all equal temp
fix temp_output all print 1 "$(step),${temp_all}" file ../output/temperature.csv screen no title "Step,Temperature"


# --- Use a consistent thermo_style for all runs ---
thermo_style custom step temp etotal v_Lcnt
thermo 100  # or 10 or 1 for higher resolution

compute Tmid cnt_mid temp
thermo 300
thermo_style custom step temp etotal v_Lcnt
thermo_modify temp Tmid line yaml

timestep 0.005
run 300

velocity cnt_top set 0.003 0 0
velocity cnt_bot set -0.003 0 0

run ${LEFT_FORCE_DURATION}

# Remove force constraint from cnt_bot to let it jiggle
unfix mysf2

# Redefine Fcnt to avoid referencing mysf2, or skip outputting v_Fcnt
thermo_style custom step temp etotal v_Lcnt
thermo 100

# Gradually release force constraint on cnt_bot
fix mysf2 cnt_bot setforce 0.1 0.0 0.0
run 300
fix mysf2 cnt_bot setforce 0.01 0.0 0.0
run 300
fix mysf2 cnt_bot setforce 0.0 0.0 0.0
run 300
unfix mysf2
# Optionally, add a short NVT equilibration
fix mynvt2 cnt_bot nvt temp 300 300 500
run 300
unfix mynvt2

# Optional: minimize or equilibrate
minimize 1.0e-4 1.0e-6 100 1000
# or
# fix mynvt2 cnt_bot nvt temp 300 300 100
# run 2000
# unfix mynvt2

run 10000
