# LAMMPS Input Script for Lennard-Jones Liquid Simulation
# This script simulates a simple atomic liquid using the Lennard-Jones potential
# Version: 2025-10-30 - Fixed random atom placement

# ==================== Initialization ====================
units           lj              # Use reduced LJ units
dimension       3
atom_style      atomic
boundary        p p p           # Periodic boundary conditions

# ==================== System Setup ====================
# Calculate box size from number of atoms and density
# density = N / V, where V = L^3
# L = (N / density)^(1/3)

variable        L equal (${numAtoms}/${density})^(1.0/3.0)
variable        halfL equal $L/2.0
# Create box centered at origin following Google DeepMind example
region          simbox block -${halfL} ${halfL} -${halfL} ${halfL} -${halfL} ${halfL} units box
create_box      1 simbox
# Use random atom placement to avoid overlaps
create_atoms    1 random ${numAtoms} 12345 simbox

# ==================== Interaction Potential ====================
# Lennard-Jones potential with cutoff
# V(r) = 4*epsilon*[(sigma/r)^12 - (sigma/r)^6]
# In LJ units: epsilon = 1.0, sigma = 1.0

pair_style      lj/cut ${cutoff}
pair_coeff      1 1 1.0 1.0     # epsilon=1.0, sigma=1.0
mass            1 1.0            # mass = 1.0 in LJ units

# ==================== Neighbor List Settings ====================
neighbor        0.3 bin
neigh_modify    every 1 delay 0 check yes

# ==================== Energy Minimization ====================
# Minimize energy to remove any overlapping atoms before starting dynamics
# This prevents "lost atoms" errors from atoms with excessive forces
print           "=========================================="
print           "Starting Energy Minimization"
print           "=========================================="
minimize        1.0e-4 1.0e-6 1000 10000

# ==================== Initial Velocities ====================
# Create velocities after minimization to match target temperature
velocity        all create ${temperature} 12345 dist gaussian mom yes rot yes

# ==================== Output Settings ====================
# Thermodynamic output
# LAMMPS if statements can only execute one command, so we use two separate thermo_style commands
if ${calcTemp}==true then "thermo_style   custom step temp press pe ke etotal vol density"
if ${calcTemp}==false then "thermo_style   custom step press pe ke etotal vol density"

thermo          ${outputFreq}

# Trajectory output
dump            1 all custom ${outputFreq} trajectory.lammpstrj id type x y z vx vy vz
dump_modify     1 sort id

# Temperature output (if enabled)
if ${calcTemp}==true then "fix            tempout all print ${outputFreq} '$(step),$(temp)' file temperature.csv screen no title 'Step,Temperature'"

# Energy output
fix             energyout all print ${outputFreq} '$(step),$(pe),$(ke),$(etotal)' file energy.csv screen no title 'Step,PE,KE,TotalEnergy'

# Pressure output
fix             pressout all print ${outputFreq} '$(step),$(press)' file pressure.csv screen no title 'Step,Pressure'

# ==================== Equilibration Phase ====================
print           "=========================================="
print           "Starting Equilibration Phase"
print           "=========================================="

timestep        ${timestep}

# Apply appropriate ensemble for equilibration
# LAMMPS if statements can only execute one command, so we use separate if statements
if ${ensemble}==nve then "fix            1 all nve"
if ${ensemble}==nvt then "fix            1 all nvt temp ${temperature} ${temperature} $(100.0*dt)"
if ${ensemble}==npt then "fix            1 all npt temp ${temperature} ${temperature} $(100.0*dt) iso 1.0 1.0 $(1000.0*dt)"

run             ${equilSteps}

# ==================== Production Phase ====================
# Note: Timesteps continue from equilibration (no reset needed)
print           "=========================================="
print           "Starting Production Phase"
print           "=========================================="

# Calculate Radial Distribution Function (RDF) if enabled
# LAMMPS if statements can only execute one command, so we use separate if statements
if ${calculateRDF}==true then "compute         rdf_calc all rdf 200 cutoff ${cutoff}"
if ${calculateRDF}==true then "fix             rdf_output all ave/time 1 ${prodSteps} ${prodSteps} c_rdf_calc[*] file rdf.dat mode vector"
if ${calculateRDF}==true then "print           'RDF calculation enabled - output will be saved to rdf.dat'"

run             ${prodSteps}

# Clean up RDF compute if it was enabled
if ${calculateRDF}==true then "unfix           rdf_output"
if ${calculateRDF}==true then "uncompute       rdf_calc"

# ==================== Final Output ====================
print           "=========================================="
print           "Simulation Complete"
print           "=========================================="

# Write final configuration
write_data      final_config.data
write_restart   final_restart.restart

print           "Final thermodynamic state:"
print           "  Temperature: $(temp)"
print           "  Pressure: $(press)"
print           "  Potential Energy: $(pe)"
print           "  Kinetic Energy: $(ke)"
print           "  Total Energy: $(etotal)"
print           "  Volume: $(vol)"
print           "  Density: $(density)"
print           "=========================================="
